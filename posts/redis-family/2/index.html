<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Redis学习记录(二) | </title><meta name="keywords" content="redis,持久化,哨兵"><meta name="author" content="Gao zj"><meta name="copyright" content="Gao zj"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Redis 持久化RDB 快照 默认Redis 将内存数据库快照保存在名为 dump.rdb 的二进制文件中save 60 1000 &#x2F;&#x2F; “60秒内有至少1000个键被改动”，自动保存一次数据集关闭RDB 只需要将所有的save 保存策略注释掉即可进入redis 客户端执行命令save 或bgsave 可以生成dump.rbd 文件，每次执行命令都会将所有redis 内存快照保存到一个rdb 文">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis学习记录(二)">
<meta property="og:url" content="http://example.com/posts/redis-family/2/index.html">
<meta property="og:site_name">
<meta property="og:description" content="Redis 持久化RDB 快照 默认Redis 将内存数据库快照保存在名为 dump.rdb 的二进制文件中save 60 1000 &#x2F;&#x2F; “60秒内有至少1000个键被改动”，自动保存一次数据集关闭RDB 只需要将所有的save 保存策略注释掉即可进入redis 客户端执行命令save 或bgsave 可以生成dump.rbd 文件，每次执行命令都会将所有redis 内存快照保存到一个rdb 文">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://example.com/img/bg-redis.jpg">
<meta property="article:published_time" content="2020-11-02T02:11:10.000Z">
<meta property="article:modified_time" content="2021-04-25T01:46:56.719Z">
<meta property="article:author" content="Gao zj">
<meta property="article:tag" content="redis">
<meta property="article:tag" content="持久化">
<meta property="article:tag" content="哨兵">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/img/bg-redis.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/posts/redis-family/2/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-right"},
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-04-25 09:46:56'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><div class="aplayer" data-id="797214285" data-server="netease" data-type="playlist" data-fixed="true" data-listFolded="false" data-order="random" data-preload="none"></div><link rel="stylesheet" href="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.css"><script src="https://cdn.bootcss.com/aplayer/1.10.1/APlayer.min.js"></script><script src="https://cdn.jsdelivr.net/npm/meting@1.2.0/dist/Meting.min.js"></script><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    })(window)</script><link rel="stylesheet" href="/css/background.css"><link rel="stylesheet" href="/css/VolantisTags.css"><link rel="stylesheet" href="/css/mycss.css"><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="author-avatar"><img class="avatar-img" src="/img/loading.gif" data-original="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/img/bg-redis.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/"></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 归档</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/timeline/"><i class="fa-fw fa fa-bell"></i><span> 日志</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fa fa-list"></i><span> 菜单</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/%E5%85%B3%E4%BA%8E"><i class="fa-fw /about/"></i><span> 0</span></a></li><li><a class="site-page child" href="/myself"><i class="fa-fw /myself/"></i><span> 1</span></a></li><li><a class="site-page child" href="/butterfly%E4%B8%BB%E9%A2%98"><i class="fa-fw https://github.com/jerryc127/hexo-theme-butterfly/"></i><span> 2</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Redis学习记录(二)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2020-11-02T02:11:10.000Z" title="发表于 2020-11-02 10:11:10">2020-11-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-04-25T01:46:56.719Z" title="更新于 2021-04-25 09:46:56">2021-04-25</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Redis学习记录(二)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h3 id="Redis-持久化"><a href="#Redis-持久化" class="headerlink" title="Redis 持久化"></a>Redis 持久化</h3><h4 id="RDB-快照"><a href="#RDB-快照" class="headerlink" title="RDB 快照"></a>RDB 快照</h4><blockquote>
<p>默认Redis 将内存数据库快照保存在名为 <code>dump.rdb</code> 的二进制文件中<br><code>save 60 1000</code> // “60秒内有至少1000个键被改动”，自动保存一次数据集<br>关闭RDB 只需要将所有的save 保存策略注释掉即可<br>进入redis 客户端执行命令<code>save</code> 或<code>bgsave</code> 可以生成<code>dump.rbd</code> 文件，每次执行命令都会将所有redis 内存快照保存到一个rdb 文件里，并覆盖原有的rdb 快照文件</p>
</blockquote>
<h4 id="bgsave-的写时复制-COW-机制"><a href="#bgsave-的写时复制-COW-机制" class="headerlink" title="bgsave 的写时复制(COW)机制"></a>bgsave 的写时复制(COW)机制</h4><blockquote>
<p>Redis 借助操作系统提供的写时复制技术（Copy-On-Write, COW），在生成快照的同时，依然可以正常处理写命令。简单来说，bgsave 子进程是由主线程 fork 生成的，可以共享主线程的所有内存数据。 bgsave 子进程运行后，开始读取主线程的内存数据，并把它们写入 RDB 文件。此时，如果主线程对这些数据也都是读操作，那么，主线程和 bgsave 子进程相互不影响。但是，如果主线程要修改一块数据，那么，这块数据就会被复制一份，生成该数据的副本。然后，bgsave 子进程会把这个副本数据写入 RDB 文件，而在这个过程中，主线程仍然可以直接修改原来的数据。写时复制机制保证快照期间数据可修改这既保证了快照的完整性，也允许主线程同时对数据进行修改，避免了对正常业务的影响。</p>
</blockquote>
<h4 id="save-与bgsave-对比"><a href="#save-与bgsave-对比" class="headerlink" title="save 与bgsave 对比"></a>save 与bgsave 对比</h4><table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>save</strong></th>
<th><strong>bgsave</strong></th>
</tr>
</thead>
<tbody><tr>
<td>IO 类型</td>
<td>同步</td>
<td>异步</td>
</tr>
<tr>
<td>是否阻塞redis 其它命令</td>
<td>是</td>
<td>否(在生成子进程执行调用fork函数时会短暂阻塞)</td>
</tr>
<tr>
<td>复杂度</td>
<td>O(n)</td>
<td>O(n)</td>
</tr>
<tr>
<td>优点</td>
<td>不会消耗额外内存</td>
<td>不阻塞客户端命令</td>
</tr>
<tr>
<td>缺点</td>
<td>阻塞客户端命令</td>
<td>需要fork 子进程，消耗内存</td>
</tr>
</tbody></table>
<p><strong>配置自动生成rdb 文件后台使用的是bgsave 方式</strong></p>
<h4 id="AOF-append-only-file"><a href="#AOF-append-only-file" class="headerlink" title="AOF(append-only file)"></a>AOF(append-only file)</h4><p>快照功能并不是非常耐久（durable）： 如果 Redis 因为某些原因而造成故障停机，那么服务器将丢失最近写入、且仍未保存到快照中的那些数据。从 1.1 版本开始， Redis 增加了一种完全耐久的持久化方式： AOF 持久化，将<strong>修改的</strong>每一条指令记录进文件appendonly.aof中(先写入os cache，每隔一段时间fsync到磁盘)</p>
<p>你可以通过修改配置文件来打开 AOF 功能：<code>appendonly yes</code><br>你可以配置 Redis 多久才将数据 fsync 到磁盘一次，三个选项：</p>
<blockquote>
<p><code>appendfsync always</code>：每次有新命令追加到 AOF 文件时就执行一次 fsync ，非常慢，也非常安全<br><code>appendfsync everysec</code>：每秒 fsync 一次，足够快，并且在故障时只会丢失 1 秒钟的数据<br><code>appendfsync no</code>：从不 fsync ，将数据交给操作系统来处理。更快，也更不安全的选择</p>
</blockquote>
<p>推荐（并且也是默认）的措施为每秒 fsync 一次， 这种 fsync 策略可以兼顾速度和安全性</p>
<h4 id="AOF-重写"><a href="#AOF-重写" class="headerlink" title="AOF 重写"></a>AOF 重写</h4><p>AOF文件里可能有太多没用指令，所以AOF会定期根据<strong>内存的最新数据</strong>生成aof文件<br>如下两个配置可以控制AOF自动重写频率：</p>
<blockquote>
<p> auto‐aof‐rewrite‐min‐size 64mb //aof文件至少要达到64M才会自动重写，文件太小恢复速度本来就很快，重写的意义不大<br>  auto‐aof‐rewrite‐percentage 100 //aof文件自上一次重写后文件大小增长了100%则再次触发重写</p>
</blockquote>
<p>当然AOF还可以手动重写，进入redis客户端执行命令<strong>bgrewriteaof</strong>重写AOF<br>注意，<strong>AOF重写redis会fork出一个子进程去做(与bgsave命令类似)，不会对redis正常命令处理有太多影响</strong></p>
<p>RDB 和AOF，选择对比</p>
<table>
<thead>
<tr>
<th><strong>命令</strong></th>
<th><strong>RDB</strong></th>
<th><strong>AOF</strong></th>
</tr>
</thead>
<tbody><tr>
<td>启动优先级</td>
<td>低</td>
<td>高</td>
</tr>
<tr>
<td>体积</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>恢复速度</td>
<td>快</td>
<td>慢</td>
</tr>
<tr>
<td>数据安全性</td>
<td>容易丢数据</td>
<td>根据策略决定</td>
</tr>
</tbody></table>
<p>生产环境可以都启用，redis启动时如果既有rdb文件又有aof文件则优先选择aof文件恢复数据，因为aof 一般来说数据更全一点。</p>
<h4 id="Redis-4-0-混合持久化"><a href="#Redis-4-0-混合持久化" class="headerlink" title="Redis 4.0 混合持久化"></a>Redis 4.0 混合持久化</h4><p>重启 Redis 时，我们很少使用 RDB来恢复内存状态，因为会丢失大量数据。我们通常使用 AOF 日志重放，但是重放 AOF 日志性能相对 RDB来说要慢很多，这样在 Redis 实例很大的情况下，启动需要花费很长的时间。 Redis 4.0 为了解决这个问题，带来了一个新的持久化选项——混合持久化。</p>
<p>通过如下配置可以开启混合持久化(<strong>必须先开启aof</strong>)：<code>aof‐use‐rdb‐preamble yes</code></p>
<p>如果开启了混合持久化，<strong>AOF在重写时</strong>，不再是单纯将内存数据转换为RESP命令写入AOF文件，而是将重写<strong>这一刻之前</strong>的内存做RDB快照处理，并且将RDB快照内容和<strong>增量的</strong>AOF修改内存数据的命令存在一起，都写入新的AOF文件，新的文件一开始不叫appendonly.aof，等到重写完新的AOF文件才会进行改名，覆盖原有的AOF文件，完成新旧两个AOF文件的替换。<br>于是在 Redis 重启的时候，可以先加载 RDB 的内容，然后再重放增量 AOF 日志就可以完全替代之前的 AOF 全量文件重放，因此重启效率大幅得到提升。</p>
<p>混合持久化AOF 文件结构如下：</p>
<p><img src="/img/loading.gif" data-original="/images/redis/redis-1.png" alt="redis-1"></p>
<p>Redis 数据备份策略：<br>1、写crontab定时调度脚本，每小时都copy一份rdb或aof的备份到一个目录中去，仅仅保留最近48小时的备份<br>2、每天都保留一份当日的数据备份到一个目录中去，可以保留最近1个月的备份<br>3、每次copy备份的时候，都把太旧的备份给删了<br>4、每天晚上将当前机器上的备份复制一份到其他机器上，以防机器损坏</p>
<h3 id="Redis-主从架构"><a href="#Redis-主从架构" class="headerlink" title="Redis 主从架构"></a>Redis 主从架构</h3><p><img src="/img/loading.gif" data-original="/images/redis/redis-2.png" alt="redis-2"></p>
<h4 id="redis-主从架构搭建，配置从节点步骤"><a href="#redis-主从架构搭建，配置从节点步骤" class="headerlink" title="redis 主从架构搭建，配置从节点步骤"></a>redis 主从架构搭建，配置从节点步骤</h4><blockquote>
<p>1、复制一份redis.conf文件<br>2、将相关配置修改为如下值：<br><code>port 6380</code><br><code>pidfile /var/run/redis_6380.pid</code>  # 把pid进程号写入pidfile配置的文件<br><code>logfile &quot;6380.log&quot;</code><br><code>dir /usr/local/redis-5.0.3/data/6380</code>  # 指定数据存放目录<br>3、配置主从复制<br><code>replicaof 192.168.0.60 6379</code>   # 从本机6379的redis实例复制数据，Redis 5.0之前使用slaveof<br><code>replica-read-only yes</code>  # 配置从节点只读<br>4、启动从节点<br><code>redis-server redis.conf</code><br>5、连接从节点<br><code>redis-cli -p 6380</code><br>6、测试在6379实例上写数据，6380实例是否能及时同步新修改数据<br>7、可以自己再配置一个6381的从节点</p>
</blockquote>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_2300688967/article/details/82351348">远程客户端无法登录Redis服务器报错问题解决</a></p>
<h4 id="Redis-主从工作原理"><a href="#Redis-主从工作原理" class="headerlink" title="Redis 主从工作原理"></a>Redis 主从工作原理</h4><p>如果你为master配置了一个slave，不管这个slave是否是第一次连接上Master，它都会发送一个PSYNC命令给master请求复制数据。<br>master收到PSYNC命令后，会在后台进行数据持久化通过bgsave生成最新的rdb快照文件，持久化期间，master会继续接收客户端的请求，它会把这些可能修改数据集的请求缓存在内存中。当持久化进行完毕以后，master会把这份rdb文件数据集发送给slave，slave会把接收到的数据进行持久化生成rdb，然后再加载到内存中。然后，master再将之前缓存在内存中的命令发送给slave。<br>当master与slave之间的连接由于某些原因而断开时，slave能够自动重连Master，如果master收到了多个slave并发连接请求，它只会进行一次持久化，而不是一个连接一次，然后再把这一份持久化的数据发送给多个并发连接的slave。</p>
<h4 id="主从复制-全量复制-流程图："><a href="#主从复制-全量复制-流程图：" class="headerlink" title="主从复制(全量复制)流程图："></a>主从复制(全量复制)流程图：</h4><p><img src="/img/loading.gif" data-original="/images/redis/redis-3.png" alt="redis-3"></p>
<h4 id="数据部分复制"><a href="#数据部分复制" class="headerlink" title="数据部分复制"></a>数据部分复制</h4><p>当master和slave断开重连后，一般都会对整份数据进行复制。但从redis2.8版本开始，redis改用可以支持部分数据复制的命令PSYNC去master同步数据，slave与master能够在网络连接断开重连后只进行部分数据复制(<strong>断点续传</strong>)。<br>master会在其内存中创建一个复制数据用的缓存队列，缓存最近一段时间的数据，master和它所有的slave都维护了复制的数据下标offset和master的进程id，因此，当网络连接断开后，slave会请求master继续进行未完成的复制，从所记录的数据下标开始。如果master进程id变化了，或者从节点数据下标offset太旧，已经不在master的缓存队列里了，那么将会进行一次全量数据的复制。</p>
<h4 id="主从复制-部分复制，断点续传-流程图："><a href="#主从复制-部分复制，断点续传-流程图：" class="headerlink" title="主从复制(部分复制，断点续传)流程图："></a>主从复制(部分复制，断点续传)流程图：</h4><p><img src="/img/loading.gif" data-original="/images/redis/redis-4.png" alt="redis-4"></p>
<p>如果有很多从节点，为了缓解主<strong>从复制风暴</strong>(多个从节点同时复制主节点导致主节点压力过大)，可以做如下架构，让部分从节点与从节点(与主节点同步)同步数据</p>
<p><img src="/img/loading.gif" data-original="/images/redis/redis-5.png" alt="redis-5"></p>
<h4 id="Jedis-连接代码示例："><a href="#Jedis-连接代码示例：" class="headerlink" title="Jedis 连接代码示例："></a>Jedis 连接代码示例：</h4><p>1、引入相关依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;redis.clients&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jedis&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.9.0&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>
<p>访问代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public class JedisSingleTest &#123;</span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">        JedisPoolConfig jedisPoolConfig &#x3D; new JedisPoolConfig();</span><br><span class="line">        jedisPoolConfig.setMaxTotal(20);</span><br><span class="line">        jedisPoolConfig.setMaxIdle(10);</span><br><span class="line">        jedisPoolConfig.setMinIdle(5);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; timeout，这里既是连接超时又是读写超时，从Jedis 2.8开始有区分connectionTimeout和soTimeout的构造函数</span><br><span class="line">        JedisPool jedisPool &#x3D; new JedisPool(jedisPoolConfig, &quot;192.168.0.60&quot;, 6379, 3000, null);</span><br><span class="line"></span><br><span class="line">        Jedis jedis &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            &#x2F;&#x2F;从redis连接池里拿出一个连接执行命令</span><br><span class="line">            jedis &#x3D; jedisPool.getResource();</span><br><span class="line"></span><br><span class="line">            System.out.println(jedis.set(&quot;single&quot;, &quot;gac&quot;));</span><br><span class="line">            System.out.println(jedis.get(&quot;single&quot;));</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;管道示例</span><br><span class="line">            &#x2F;&#x2F;管道的命令执行方式：cat redis.txt | redis-cli -h 127.0.0.1 -a password - p 6379 --pipe</span><br><span class="line">            &#x2F;*Pipeline pl &#x3D; jedis.pipelined();</span><br><span class="line">            for (int i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">                pl.incr(&quot;pipelineKey&quot;);</span><br><span class="line">                pl.set(&quot;gac&quot; + i, &quot;gac&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;Object&gt; results &#x3D; pl.syncAndReturnAll();</span><br><span class="line">            System.out.println(results);*&#x2F;</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F;lua脚本模拟一个商品减库存的原子操作</span><br><span class="line">            &#x2F;&#x2F;lua脚本命令执行方式：redis-cli --eval &#x2F;tmp&#x2F;test.lua , 10</span><br><span class="line">            &#x2F;*jedis.set(&quot;product_count_10016&quot;, &quot;15&quot;);  &#x2F;&#x2F;初始化商品10016的库存</span><br><span class="line">            String script &#x3D; &quot; local count &#x3D; redis.call(&#39;get&#39;, KEYS[1]) &quot; +</span><br><span class="line">                            &quot; local a &#x3D; tonumber(count) &quot; +</span><br><span class="line">                            &quot; local b &#x3D; tonumber(ARGV[1]) &quot; +</span><br><span class="line">                            &quot; if a &gt;&#x3D; b then &quot; +</span><br><span class="line">                            &quot;   redis.call(&#39;set&#39;, KEYS[1], a-b) &quot; +</span><br><span class="line">                            &quot;   return 1 &quot; +</span><br><span class="line">                            &quot; end &quot; +</span><br><span class="line">                            &quot; return 0 &quot;;</span><br><span class="line">            Object obj &#x3D; jedis.eval(script, Arrays.asList(&quot;product_count_10016&quot;), Arrays.asList(&quot;10&quot;));</span><br><span class="line">            System.out.println(obj);*&#x2F;</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            &#x2F;&#x2F;注意这里不是关闭连接，在JedisPool模式下，Jedis会被归还给资源池。</span><br><span class="line">            if (jedis !&#x3D; null)</span><br><span class="line">                jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>redis管道与调用lua脚本，代码示例上面已经给出：</strong></p>
<p><strong>管道（Pipeline）</strong></p>
<p>客户端可以一次性发送多个请求而不用等待服务器的响应，待所有命令都发送完后再一次性读取服务的响应，这样可以极大的降低多条命令执行的网络传输开销，管道执行多条命令的网络开销实际上只相当于一次命令执行的网络开销。需要注意到是用pipeline方式打包命令发送，redis必须在<strong>处理完所有命令前先缓存起所有命令的处理结果</strong>。打包的命令越多，缓存消耗内存也越多。所以并不是打包的命令越多越好。</p>
<p>pipeline中发送的每个command都会被server立即执行，如果执行失败，将会在此后的响应中得到信息；也就是pipeline并不是表达“所有command都一起成功”的语义，管道中前面命令失败，后面命令不会有影响，继续执行。<br>详细代码示例见上面jedis连接示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Pipeline pl &#x3D; jedis.pipelined();</span><br><span class="line">for (int i &#x3D; 0; i &lt; 10; i++) &#123;</span><br><span class="line">    pl.incr(&quot;pipelineKey&quot;);</span><br><span class="line">    pl.set(&quot;gac&quot; + i, &quot;gac&quot;);</span><br><span class="line">    &#x2F;&#x2F;模拟管道报错</span><br><span class="line">    &#x2F;&#x2F; pl.setbit(&quot;gac&quot;, -1, true);</span><br><span class="line">&#125;</span><br><span class="line">List&lt;Object&gt; results &#x3D; pl.syncAndReturnAll();</span><br><span class="line">System.out.println(results);</span><br></pre></td></tr></table></figure>

<p><strong>Redis Lua脚本</strong></p>
<p>Redis在2.6推出了脚本功能，允许开发者使用Lua语言编写脚本传到Redis中执行。使用脚本的好处如下:</p>
<p>1、<strong>减少网络开销</strong>：本来5次网络请求的操作，可以用一个请求完成，原先5次请求的逻辑放在redis服务器上完成。使用脚本，减少了网络往返时延。<strong>这点跟管道类似</strong>。</p>
<p>2、<strong>原子操作</strong>：Redis会将整个脚本作为一个整体执行，中间不会被其他命令插入。<strong>管道不是原子的，不过redis的批量操作命令(类似mset)是原子的</strong>。</p>
<p>3、<strong>替代redis的事务功能</strong>：redis自带的事务功能很鸡肋，报错不支持回滚，而redis的lua脚本几乎实现了常规的事务功能，支持报错回滚操作，官方推荐如果要使用redis的事务功能可以用redis lua替代。</p>
<p><strong>官网文档上有这样一段话</strong>：</p>
<blockquote>
<p>A Redis script is transactional by definition, so everything you can do with a Redis transaction, you can also do with a script,<br>and usually the script will be both simpler and faster.</p>
</blockquote>
<p>从Redis2.6.0版本开始，通过内置的Lua解释器，可以使用EVAL命令对Lua脚本进行求值。EVAL命令的格式如下</p>
<blockquote>
<p>EVAL script numkeys key [key …] arg [arg …]　</p>
</blockquote>
<p>script参数是一段Lua脚本程序，它会被运行在Redis服务器上下文中，这段脚本<strong>不必(也不应该)定义为一个Lua函数</strong>。numkeys参数用于指定键名参数的个数。键名参数 key [key …] 从EVAL的第三个参数开始算起，表示在脚本中所用到的那些Redis键(key)，这些键名参数可以在 Lua中通过全局变量KEYS数组，用1为基址的形式访问( KEYS[1] ， KEYS[2] ，以此类推)。</p>
<p>在命令的最后，那些不是键名参数的附加参数 arg [arg …] ，可以在Lua中通过全局变量ARGV数组访问，访问的形式和KEYS变量类似( ARGV[1] 、 ARGV[2] ，诸如此类)。例如</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; eval &quot;return &#123;KEYS[1],KEYS[2],ARGV[1],ARGV[2]&#125;&quot; 2 key1 key2 first second</span><br><span class="line">1) &quot;key1&quot;</span><br><span class="line">2) &quot;key2&quot;</span><br><span class="line">3) &quot;first&quot;</span><br><span class="line">4) &quot;second&quot;</span><br></pre></td></tr></table></figure>

<p>其中 “return {KEYS[1],KEYS[2],ARGV[1],ARGV[2]}” 是被求值的Lua脚本，数字2指定了键名参数的数量， key1和key2是键名参数，分别使用 KEYS[1] 和 KEYS[2] 访问，而最后的 first 和 second 则是附加参数，可以通过 ARGV[1] 和 ARGV[2] 访问它们。</p>
<p>在 Lua 脚本中，可以使用**redis.call()**函数来执行Redis命令<br>Jedis调用示例详见上面jedis连接示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">jedis.set(&quot;product_stock_10016&quot;, &quot;15&quot;);  &#x2F;&#x2F;初始化商品10016的库存</span><br><span class="line">String script &#x3D; &quot; local count &#x3D; redis.call(&#39;get&#39;, KEYS[1]) &quot; +</span><br><span class="line">                &quot; local a &#x3D; tonumber(count) &quot; +</span><br><span class="line">                &quot; local b &#x3D; tonumber(ARGV[1]) &quot; +</span><br><span class="line">                &quot; if a &gt;&#x3D; b then &quot; +</span><br><span class="line">                &quot;   redis.call(&#39;set&#39;, KEYS[1], a-b) &quot; +</span><br><span class="line">                &#x2F;&#x2F;模拟语法报错回滚操作&quot;   bb &#x3D;&#x3D; 0 &quot; +</span><br><span class="line">                &quot;   return 1 &quot; +</span><br><span class="line">                &quot; end &quot; +</span><br><span class="line">                &quot; return 0 &quot;;</span><br><span class="line">Object obj &#x3D; jedis.eval(script, Arrays.asList(&quot;product_stock_10016&quot;), Arrays.asList(&quot;10&quot;));</span><br><span class="line">System.out.println(obj);</span><br></pre></td></tr></table></figure>

<p><strong>注意，不要在Lua脚本中出现死循环和耗时的运算，否则redis会阻塞，将不接受其他的命令， 所以使用时要注意不能出现死循环、耗时的运算。redis是单进程、单线程执行脚本。管道不会阻塞redis。</strong></p>
<h3 id="Redis哨兵高可用架构"><a href="#Redis哨兵高可用架构" class="headerlink" title="Redis哨兵高可用架构"></a>Redis哨兵高可用架构</h3><p><img src="/img/loading.gif" data-original="/images/redis/sentinel-1.png" alt="sentinel-1"></p>
<p>sentinel哨兵是特殊的redis服务，不提供读写服务，主要用来监控redis实例节点。<br>哨兵架构下client端第一次从哨兵找出redis的主节点，后续就直接访问redis的主节点，不会每次都通过sentinel代理访问redis的主节点，当redis的主节点发生变化，哨兵会第一时间感知到，并且将新的redis主节点通知给client端(这里面redis的client端一般都实现了订阅功能，订阅sentinel发布的节点变动消息)</p>
<p><strong>redis哨兵架构搭建步骤：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1、复制一份sentinel.conf文件</span><br><span class="line">cp sentinel.conf sentinel-26379.conf</span><br><span class="line"></span><br><span class="line">2、将相关配置修改为如下值：</span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile &quot;&#x2F;var&#x2F;run&#x2F;redis-sentinel-26379.pid&quot;</span><br><span class="line">logfile &quot;26379.log&quot;</span><br><span class="line">dir &quot;&#x2F;usr&#x2F;local&#x2F;redis-5.0.3&#x2F;data&quot;</span><br><span class="line"># sentinel monitor &lt;master-redis-name&gt; &lt;master-redis-ip&gt; &lt;master-redis-port&gt; &lt;quorum&gt;</span><br><span class="line"># quorum是一个数字，指明当有多少个sentinel认为一个master失效时(值一般为：sentinel总数&#x2F;2 + 1)，master才算真正失效</span><br><span class="line">sentinel monitor mymaster 192.168.0.60 6379 2   # mymaster这个名字随便取，客户端访问时会用到</span><br><span class="line"></span><br><span class="line">3、启动sentinel哨兵实例</span><br><span class="line">src&#x2F;redis-sentinel sentinel-26379.conf</span><br><span class="line"></span><br><span class="line">4、查看sentinel的info信息</span><br><span class="line">src&#x2F;redis-cli -p 26379</span><br><span class="line">127.0.0.1:26379&gt;info</span><br><span class="line">可以看到Sentinel的info里已经识别出了redis的主从</span><br><span class="line"></span><br><span class="line">5、可以自己再配置两个sentinel，端口26380和26381，注意上述配置文件里的对应数字都要修改</span><br></pre></td></tr></table></figure>

<p>sentinel集群都启动完毕后，会将哨兵集群的元数据信息写入所有sentinel的配置文件里去(追加在文件的最下面)，我们查看下如下配置文件sentinel-26379.conf，如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sentinel known-replica mymaster 192.168.0.60 6380 #代表redis主节点的从节点信息</span><br><span class="line">sentinel known-replica mymaster 192.168.0.60 6381 #代表redis主节点的从节点信息</span><br><span class="line">sentinel known-sentinel mymaster 192.168.0.60 26380 52d0a5d70c1f90475b4fc03b6ce7c3c56935760f  #代表感知到的其它哨兵节点</span><br><span class="line">sentinel known-sentinel mymaster 192.168.0.60 26381 e9f530d3882f8043f76ebb8e1686438ba8bd5ca6  #代表感知到的其它哨兵节点</span><br></pre></td></tr></table></figure>

<p>当redis主节点如果挂了，哨兵集群会重新选举出新的redis主节点，同时会修改所有sentinel节点配置文件的集群元数据信息，比如6379的redis如果挂了，假设选举出的新主节点是6380，则sentinel文件里的集群元数据信息会变成如下所示：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sentinel known-replica mymaster 192.168.0.60 6379 #代表主节点的从节点信息</span><br><span class="line">sentinel known-replica mymaster 192.168.0.60 6381 #代表主节点的从节点信息</span><br><span class="line">sentinel known-sentinel mymaster 192.168.0.60 26380 52d0a5d70c1f90475b4fc03b6ce7c3c56935760f  #代表感知到的其它哨兵节点</span><br><span class="line">sentinel known-sentinel mymaster 192.168.0.60 26381 e9f530d3882f8043f76ebb8e1686438ba8bd5ca6  #代表感知到的其它哨兵节点</span><br></pre></td></tr></table></figure>

<p>同时还会修改sentinel文件里之前配置的mymaster对应的6379端口，改为6380</p>
<p>sentinel monitor mymaster 192.168.0.60 6380 2</p>
<p>当6379的redis实例再次启动时，哨兵集群根据集群元数据信息就可以将6379端口的redis节点作为从节点加入集群</p>
<p>哨兵的Jedis连接代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class JedisSentinelTest &#123;</span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line"></span><br><span class="line">        JedisPoolConfig config &#x3D; new JedisPoolConfig();</span><br><span class="line">        config.setMaxTotal(20);</span><br><span class="line">        config.setMaxIdle(10);</span><br><span class="line">        config.setMinIdle(5);</span><br><span class="line"></span><br><span class="line">        String masterName &#x3D; &quot;mymaster&quot;;</span><br><span class="line">        Set&lt;String&gt; sentinels &#x3D; new HashSet&lt;String&gt;();</span><br><span class="line">        sentinels.add(new HostAndPort(&quot;192.168.0.60&quot;,26379).toString());</span><br><span class="line">        sentinels.add(new HostAndPort(&quot;192.168.0.60&quot;,26380).toString());</span><br><span class="line">        sentinels.add(new HostAndPort(&quot;192.168.0.60&quot;,26381).toString());</span><br><span class="line">        &#x2F;&#x2F;JedisSentinelPool其实本质跟JedisPool类似，都是与redis主节点建立的连接池</span><br><span class="line">        &#x2F;&#x2F;JedisSentinelPool并不是说与sentinel建立的连接池，而是通过sentinel发现redis主节点并与其建立连接</span><br><span class="line">        JedisSentinelPool jedisSentinelPool &#x3D; new JedisSentinelPool(masterName, sentinels, config, 3000, null);</span><br><span class="line">        Jedis jedis &#x3D; null;</span><br><span class="line">        try &#123;</span><br><span class="line">            jedis &#x3D; jedisSentinelPool.getResource();</span><br><span class="line">            System.out.println(jedis.set(&quot;sentinel&quot;, &quot;gac&quot;));</span><br><span class="line">            System.out.println(jedis.get(&quot;sentinel&quot;));</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; finally &#123;</span><br><span class="line">            &#x2F;&#x2F;注意这里不是关闭连接，在JedisPool模式下，Jedis会被归还给资源池。</span><br><span class="line">            if (jedis !&#x3D; null)</span><br><span class="line">                jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>哨兵的Spring Boot整合Redis连接代码见示例项目：redis-sentinel-cluster</p>
<p>1、引入相关依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;org.springframework.boot&lt;&#x2F;groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;spring-boot-starter-data-redis&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">   &lt;groupId&gt;org.apache.commons&lt;&#x2F;groupId&gt;</span><br><span class="line">   &lt;artifactId&gt;commons-pool2&lt;&#x2F;artifactId&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>

<p>springboot项目核心配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 8080</span><br><span class="line"></span><br><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    database: 0</span><br><span class="line">    timeout: 3000</span><br><span class="line">    sentinel:    #哨兵模式</span><br><span class="line">      master: mymaster #主服务器所在集群名称</span><br><span class="line">     nodes: 192.168.0.60:26379,192.168.0.60:26380,192.168.0.60:26381</span><br><span class="line">   lettuce:</span><br><span class="line">      pool:</span><br><span class="line">        max-idle: 50</span><br><span class="line">        min-idle: 10</span><br><span class="line">        max-active: 100</span><br><span class="line">        max-wait: 1000</span><br><span class="line">    </span><br></pre></td></tr></table></figure>

<p>访问代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">@RestController</span><br><span class="line">public class IndexController &#123;</span><br><span class="line"></span><br><span class="line">    private static final Logger logger &#x3D; LoggerFactory.getLogger(IndexController.class);</span><br><span class="line"></span><br><span class="line">    @Autowired</span><br><span class="line">    private StringRedisTemplate stringRedisTemplate;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 测试节点挂了哨兵重新选举新的master节点，客户端是否能动态感知到</span><br><span class="line">     * 新的master选举出来后，哨兵会把消息发布出去，客户端实际上是实现了一个消息监听机制，</span><br><span class="line">     * 当哨兵把新master的消息发布出去，客户端会立马感知到新master的信息，从而动态切换访问的masterip</span><br><span class="line">     *</span><br><span class="line">     * @throws InterruptedException</span><br><span class="line">     *&#x2F;</span><br><span class="line">    @RequestMapping(&quot;&#x2F;test_sentinel&quot;)</span><br><span class="line">    public void testSentinel() throws InterruptedException &#123;</span><br><span class="line">        int i &#x3D; 1;</span><br><span class="line">        while (true)&#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                stringRedisTemplate.opsForValue().set(&quot;gac&quot;+i, i+&quot;&quot;);</span><br><span class="line">                System.out.println(&quot;设置key：&quot;+ &quot;gac&quot; + i);</span><br><span class="line">                i++;</span><br><span class="line">                Thread.sleep(1000);</span><br><span class="line">            &#125;catch (Exception e)&#123;</span><br><span class="line">                logger.error(&quot;错误：&quot;, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>StringRedisTemplate与RedisTemplate详解</strong><br>spring 封装了 RedisTemplate 对象来进行对redis的各种操作，它支持所有的 redis 原生的 api。在RedisTemplate中提供了几个常用的接口方法的使用，分别是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private ValueOperations&lt;K, V&gt; valueOps;</span><br><span class="line">private HashOperations&lt;K, V&gt; hashOps;</span><br><span class="line">private ListOperations&lt;K, V&gt; listOps;</span><br><span class="line">private SetOperations&lt;K, V&gt; setOps;</span><br><span class="line">private ZSetOperations&lt;K, V&gt; zSetOps;</span><br></pre></td></tr></table></figure>

<p>RedisTemplate中定义了对5种数据结构操作</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redisTemplate.opsForValue();&#x2F;&#x2F;操作字符串</span><br><span class="line">redisTemplate.opsForHash();&#x2F;&#x2F;操作hash</span><br><span class="line">redisTemplate.opsForList();&#x2F;&#x2F;操作list</span><br><span class="line">redisTemplate.opsForSet();&#x2F;&#x2F;操作set</span><br><span class="line">redisTemplate.opsForZSet();&#x2F;&#x2F;操作有序set</span><br></pre></td></tr></table></figure>

<p>StringRedisTemplate继承自RedisTemplate，也一样拥有上面这些操作。<br>StringRedisTemplate默认采用的是String的序列化策略，保存的key和value都是采用此策略序列化保存的。<br>RedisTemplate默认采用的是JDK的序列化策略，保存的key和value都是采用此策略序列化保存的。</p>
<p><strong>Redis客户端命令对应的RedisTemplate中的方法列表：</strong></p>
<p>列表待续…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">java - redis 常用命令测试：</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForValue().set(&quot;c&quot;, &quot;123456789&quot;);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForValue().get(&quot;c&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForValue().size(&quot;c&quot;));</span><br><span class="line">&#x2F;&#x2F;        String andSet &#x3D; redisTemplate.opsForValue().getAndSet(&quot;c&quot;, &quot;987654321&quot;);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(andSet);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForValue().get(&quot;c&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForValue().get(&quot;c&quot;, 1, 5));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForValue().append(&quot;c&quot;, &quot;0000&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForValue().get(&quot;c&quot;));</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.delete(&quot;c&quot;);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForValue().get(&quot;c&quot;));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;        HashMap&lt;Object, Object&gt; map &#x3D; new HashMap&lt;&gt;();</span><br><span class="line">&#x2F;&#x2F;        map.put(&quot;a&quot;, &quot;1&quot;);</span><br><span class="line">&#x2F;&#x2F;        map.put(&quot;b&quot;, &quot;2&quot;);</span><br><span class="line">&#x2F;&#x2F;        map.put(&quot;c&quot;, &quot;3&quot;);</span><br><span class="line">&#x2F;&#x2F;        map.put(&quot;d&quot;, &quot;5&quot;);</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForHash().putAll(&quot;c&quot;, map);</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForHash().put(&quot;c&quot;, &quot;e&quot;, &quot;7&quot;);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForHash().hasKey(&quot;c&quot;, &quot;e&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForHash().hasKey(&quot;c&quot;, &quot;f&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForHash().entries(&quot;c&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForHash().values(&quot;c&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForHash().keys(&quot;c&quot;));</span><br><span class="line">&#x2F;&#x2F;        List&lt;Object&gt; list &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">&#x2F;&#x2F;        list.add(&quot;a&quot;);</span><br><span class="line">&#x2F;&#x2F;        list.add(&quot;b&quot;);</span><br><span class="line">&#x2F;&#x2F;        list.add(&quot;ac&quot;);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForHash().multiGet(&quot;c&quot;, list));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForHash().putIfAbsent(&quot;c&quot;, &quot;a&quot;, &quot;2&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForHash().putIfAbsent(&quot;c&quot;, &quot;ac&quot;, &quot;2&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForHash().get(&quot;c&quot;, &quot;ac&quot;));</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForHash().delete(&quot;c&quot;, &quot;a&quot;, &quot;b&quot;, &quot;ac&quot;);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForHash().get(&quot;c&quot;, &quot;ac&quot;));</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForList().leftPush(&quot;c&quot;, &quot;a&quot;);</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForList().leftPushAll(&quot;c&quot;, &quot;b&quot;, &quot;d&quot;, &quot;e&quot;);</span><br><span class="line">&#x2F;&#x2F;        List&lt;String&gt; list &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">&#x2F;&#x2F;        list.add(&quot;f&quot;);</span><br><span class="line">&#x2F;&#x2F;        list.add(&quot;g&quot;);</span><br><span class="line">&#x2F;&#x2F;        list.add(&quot;h&quot;);</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForList().leftPushAll(&quot;c&quot;, list);</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForList().rightPush(&quot;c&quot;, &quot;0&quot;);</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForList().rightPushAll(&quot;c&quot;, &quot;1&quot;, &quot;2&quot;, &quot;3&quot;);</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForList().rightPushAll(&quot;c&quot;, list);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForList().index(&quot;c&quot;, 5));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForList().size(&quot;c&quot;));</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForList().leftPop(&quot;c&quot;);</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForList().rightPop(&quot;c&quot;);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForList().leftPushIfPresent(&quot;c&quot;, &quot;0&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForList().rightPushIfPresent(&quot;c&quot;, &quot;0&quot;));</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForList().range(&quot;c&quot;, 0, 20));</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForList().remove(&quot;c&quot;, 1,&quot;f&quot;);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForList().range(&quot;c&quot;, 0, 20));</span><br><span class="line">&#x2F;&#x2F;        redisTemplate.opsForList().set(&quot;c&quot;, 5, &quot;gac&quot;);</span><br><span class="line">&#x2F;&#x2F;        System.out.println(redisTemplate.opsForList().range(&quot;c&quot;, 0, 20));</span><br><span class="line"></span><br><span class="line">        redisTemplate.boundSetOps(&quot;c&quot;).add(&quot;1&quot;, &quot;2&quot;, &quot;3&quot;);</span><br><span class="line">        redisTemplate.opsForSet().add(&quot;b&quot;, &quot;2&quot;, &quot;3&quot;, &quot;5&quot;);</span><br><span class="line">        redisTemplate.opsForSet().add(&quot;a&quot;, &quot;1&quot;, &quot;b&quot;, &quot;5&quot;);</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().size(&quot;c&quot;));</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().difference(&quot;c&quot;, &quot;b&quot;));</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().intersect(&quot;c&quot;, &quot;b&quot;));</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().union(&quot;c&quot;, &quot;b&quot;));</span><br><span class="line">        redisTemplate.opsForSet().differenceAndStore(&quot;c&quot;, &quot;a&quot;, &quot;des&quot;);</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().members(&quot;des&quot;));</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().isMember(&quot;des&quot;, &quot;2&quot;));</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().isMember(&quot;des&quot;, &quot;5&quot;));</span><br><span class="line">        redisTemplate.opsForSet().intersectAndStore(&quot;c&quot;, &quot;a&quot;, &quot;des1&quot;);</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().members(&quot;des1&quot;));</span><br><span class="line">        redisTemplate.opsForSet().unionAndStore(&quot;c&quot;, &quot;b&quot;, &quot;des2&quot;);</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().members(&quot;des2&quot;));</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().pop(&quot;des2&quot;));</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().members(&quot;des2&quot;));</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().randomMembers(&quot;des2&quot;, 2));</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().randomMembers(&quot;des2&quot;, 2));</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().members(&quot;des2&quot;));</span><br><span class="line">        redisTemplate.opsForSet().remove(&quot;des2&quot;, &quot;1&quot;, &quot;2&quot;);</span><br><span class="line">        System.out.println(redisTemplate.opsForSet().members(&quot;des2&quot;));</span><br></pre></td></tr></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Gao zj</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://example.com/posts/redis-family/2/">http://example.com/posts/redis-family/2/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://example.com" target="_blank"></a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/redis/">redis</a><a class="post-meta__tags" href="/tags/%E6%8C%81%E4%B9%85%E5%8C%96/">持久化</a><a class="post-meta__tags" href="/tags/%E5%93%A8%E5%85%B5/">哨兵</a></div><div class="post_share"><div class="social-share" data-image="/img/bg-redis.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/jvm-family/"><img class="prev-cover" src="/img/loading.gif" data-original="/img/bg-jvm.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">JVM调优工具（一）</div></div></a></div><div class="next-post pull-right"><a href="/posts/redis-family/1/"><img class="next-cover" src="/img/loading.gif" data-original="/img/bg-redis.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Redis学习记录(一)</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/redis-family/3/" title="Redis学习记录(三)"><img class="cover" src="/img/loading.gif" data-original="/img/bg-redis.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-11-05</div><div class="title">Redis学习记录(三)</div></div></a></div><div><a href="/posts/redis-family/1/" title="Redis学习记录(一)"><img class="cover" src="/img/loading.gif" data-original="/img/bg-redis.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-10-31</div><div class="title">Redis学习记录(一)</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="card-info-avatar is-center"><img class="avatar-img" src="/img/loading.gif" data-original="/img/avatar.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/><div class="author-info__name">Gao zj</div><div class="author-info__description">南风知我意，吹梦到西洲</div></div><div class="card-info-data"><div class="card-info-data-item is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">31</div></a></div><div class="card-info-data-item is-center"><a href="/tags/"><div class="headline">标签</div><div class="length-num">21</div></a></div></div><a class="button--animated" id="card-info-btn" target="_blank" rel="noopener" href="https://gaoairong.github.io/"><i class="iconfont icon-CSDN"></i><span>Gao zj's Blog</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/atom.xml" target="_blank" title="RSS链接"><i class="iconfont icon-rss card_icon"></i></a><a class="social-icon" href="tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=407599698@qq.com&amp;website=www.oicqzone.com" target="_blank" title=""><i class="iconfont icon-QQ card_icon"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn card-announcement-animation"></i><span>公告</span></div><div class="announcement_content">博客构建中，待续...</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">Redis 持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RDB-%E5%BF%AB%E7%85%A7"><span class="toc-number">1.1.</span> <span class="toc-text">RDB 快照</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#bgsave-%E7%9A%84%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6-COW-%E6%9C%BA%E5%88%B6"><span class="toc-number">1.2.</span> <span class="toc-text">bgsave 的写时复制(COW)机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#save-%E4%B8%8Ebgsave-%E5%AF%B9%E6%AF%94"><span class="toc-number">1.3.</span> <span class="toc-text">save 与bgsave 对比</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF-append-only-file"><span class="toc-number">1.4.</span> <span class="toc-text">AOF(append-only file)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AOF-%E9%87%8D%E5%86%99"><span class="toc-number">1.5.</span> <span class="toc-text">AOF 重写</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-4-0-%E6%B7%B7%E5%90%88%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.6.</span> <span class="toc-text">Redis 4.0 混合持久化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis-%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text">Redis 主从架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#redis-%E4%B8%BB%E4%BB%8E%E6%9E%B6%E6%9E%84%E6%90%AD%E5%BB%BA%EF%BC%8C%E9%85%8D%E7%BD%AE%E4%BB%8E%E8%8A%82%E7%82%B9%E6%AD%A5%E9%AA%A4"><span class="toc-number">2.1.</span> <span class="toc-text">redis 主从架构搭建，配置从节点步骤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Redis-%E4%B8%BB%E4%BB%8E%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">2.2.</span> <span class="toc-text">Redis 主从工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6-%E5%85%A8%E9%87%8F%E5%A4%8D%E5%88%B6-%E6%B5%81%E7%A8%8B%E5%9B%BE%EF%BC%9A"><span class="toc-number">2.3.</span> <span class="toc-text">主从复制(全量复制)流程图：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E9%83%A8%E5%88%86%E5%A4%8D%E5%88%B6"><span class="toc-number">2.4.</span> <span class="toc-text">数据部分复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6-%E9%83%A8%E5%88%86%E5%A4%8D%E5%88%B6%EF%BC%8C%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0-%E6%B5%81%E7%A8%8B%E5%9B%BE%EF%BC%9A"><span class="toc-number">2.5.</span> <span class="toc-text">主从复制(部分复制，断点续传)流程图：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Jedis-%E8%BF%9E%E6%8E%A5%E4%BB%A3%E7%A0%81%E7%A4%BA%E4%BE%8B%EF%BC%9A"><span class="toc-number">2.6.</span> <span class="toc-text">Jedis 连接代码示例：</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Redis%E5%93%A8%E5%85%B5%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84"><span class="toc-number">3.</span> <span class="toc-text">Redis哨兵高可用架构</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/es-family/4/" title="ElasticSearch学习记录(四)"><img src="/img/loading.gif" data-original="/img/bg-es.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ElasticSearch学习记录(四)"/></a><div class="content"><a class="title" href="/posts/es-family/4/" title="ElasticSearch学习记录(四)">ElasticSearch学习记录(四)</a><time datetime="2021-04-26T12:20:39.000Z" title="发表于 2021-04-26 20:20:39">2021-04-26</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/es-family/3/" title="ElasticSearch学习记录(三)"><img src="/img/loading.gif" data-original="/img/bg-es.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ElasticSearch学习记录(三)"/></a><div class="content"><a class="title" href="/posts/es-family/3/" title="ElasticSearch学习记录(三)">ElasticSearch学习记录(三)</a><time datetime="2021-04-25T09:12:38.000Z" title="发表于 2021-04-25 17:12:38">2021-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/es-family/2/" title="ElasticSearch学习记录(二)"><img src="/img/loading.gif" data-original="/img/bg-es.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ElasticSearch学习记录(二)"/></a><div class="content"><a class="title" href="/posts/es-family/2/" title="ElasticSearch学习记录(二)">ElasticSearch学习记录(二)</a><time datetime="2021-04-25T06:53:19.000Z" title="发表于 2021-04-25 14:53:19">2021-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/es-family/1/" title="ElasticSearch学习记录(一)"><img src="/img/loading.gif" data-original="/img/bg-es.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="ElasticSearch学习记录(一)"/></a><div class="content"><a class="title" href="/posts/es-family/1/" title="ElasticSearch学习记录(一)">ElasticSearch学习记录(一)</a><time datetime="2021-04-25T01:51:46.000Z" title="发表于 2021-04-25 09:51:46">2021-04-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/mysql-family/5/" title="MySQL学习记录-五"><img src="/img/loading.gif" data-original="/img/bg-mysql.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="MySQL学习记录-五"/></a><div class="content"><a class="title" href="/posts/mysql-family/5/" title="MySQL学习记录-五">MySQL学习记录-五</a><time datetime="2020-11-10T14:46:30.000Z" title="发表于 2020-11-10 22:46:30">2020-11-10</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021  <i id="heartbeat" class="fa fas fa-heartbeat"></i> Gao zj</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div><head><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css"></head></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><script src="/js/background.js"></script><script src="/js/VolantisTags.js"></script><script type="text/javascript" src="/js/fairyDustCursor.js"></script><script defer="defer" id="fluttering_ribbon" mobile="true" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/canvas-fluttering-ribbon.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"model":{"jsonPath":"/live2dw/assets/koharu.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":false},"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script><script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(n){n.imageLazyLoadSetting.processImages=o;var e=n.imageLazyLoadSetting.isSPA,i=n.imageLazyLoadSetting.preloadRatio||1,r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function o(){e&&(r=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")));for(var t,a=0;a<r.length;a++)0<=(t=(t=r[a]).getBoundingClientRect()).bottom&&0<=t.left&&t.top<=(n.innerHeight*i||document.documentElement.clientHeight*i)&&function(){var t,e,n,i,o=r[a];t=o,e=function(){r=r.filter(function(t){return o!==t})},n=new Image,i=t.getAttribute("data-original"),n.onload=function(){t.src=i,e&&e()},t.src!==i&&(n.src=i)}()}o(),n.addEventListener("scroll",function(){var t,e;t=o,e=n,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>